/**
 * +-------------------------------------------------+
 * |                 BIZZY NATION                    |
 * |          Crafted with ♦ by Bizzy 2025         |
 * +-------------------------------------------------+
 * 
 * @file ForumSystem.js
 * @description 
 * @copyright © Bizzy Nation - All Rights Reserved
 * @license Proprietary - Not for distribution
 * 
 * This file is protected intellectual property of Bizzy Nation.
 * Unauthorized use, copying, or distribution is prohibited.
 */

import React, { useState, useEffect, useRef } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../../contexts/AuthContext';
import ForumCategory from './ForumCategory';
import ForumThread from './ForumThread';
import ForumTopicList from './ForumTopicList';
import ForumPost from './ForumPost';
import CreateThread from './CreateThread';
import api from '../../services/api';
import axios from 'axios';
import { toast } from 'react-toastify';
import { v4 as uuidv4 } from 'uuid';

// Try to import DonationModal or use a fallback
let DonationModal;
try {
  DonationModal = require('../DonationModal').default;
} catch (error) {
  console.warn('DonationModal not found, using fallback');
  DonationModal = ({ isOpen, onClose }) => isOpen ? (
    <div className="fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50">
      <div className="bg-gray-800 p-4 rounded-lg shadow">
        <h3 className="text-lg text-white">Donation Feature</h3>
        <p className="text-gray-300 my-2">The donation feature is coming soon!</p>
        <button 
          onClick={onClose} 
          className="bg-green-700 text-white px-4 py-2 rounded mt-2"
        >
          Close
        </button>
      </div>
    </div>
  ) : null;
}

// Try to import ToastContainer or use a fallback
let ToastContainer;
try {
  ToastContainer = require('react-toastify').ToastContainer;
  require('react-toastify/dist/ReactToastify.css');
} catch (error) {
  console.warn('react-toastify not found, using fallback');
  ToastContainer = () => null;
}

/**
 * Minecraft-styled Forum System
 * 
 * This component provides a complete forum system with Minecraft-inspired styling.
 * Features:
 * - Categories and subcategories
 * - Thread listing with sorting and filtering
 * - Thread creation with markdown support
 * - Post replies with quotes and formatting
 * - Minecraft-themed UI elements
 */
const ForumSystem = ({ 
  initialView = 'categories',
  selectedCategory = null,
  selectedThread = null,
  currentUser = null
}) => {
  // Get user from context if not provided
  const { user } = useAuth();
  const loggedInUser = currentUser || user;
  console.log("Forum system user:", loggedInUser);
  const navigate = useNavigate();
  const [view, setView] = useState(initialView); // 'categories', 'topics', 'thread', 'create'
  const [categories, setCategories] = useState([]);
  const [topics, setTopics] = useState([]);
  const [threads, setThreads] = useState([]);
  const [posts, setPosts] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [activeCategory, setActiveCategory] = useState(selectedCategory);
  const [activeTopic, setActiveTopic] = useState(null);
  const [activeThread, setActiveThread] = useState(selectedThread);
  const [error, setError] = useState(null);
  const [sortOrder, setSortOrder] = useState('newest'); // 'newest', 'oldest', 'popular'
  const [pageNumber, setPageNumber] = useState(1);
  const [totalPages, setTotalPages] = useState(1);
  const [showDonationModal, setShowDonationModal] = useState(false);
  const [donationRecipient, setDonationRecipient] = useState(null);
  const [categoryTopics, setCategoryTopics] = useState([]);
  
  // Track latest request to prevent race conditions
  const latestRequestId = useRef(0);

  // Initialize the component
  useEffect(() => {
    // Always fetch categories on mount
    console.log('ForumSystem initialized with view:', view);
    fetchCategories();
    
    // Add event listener for donation modal
    const handleDonationModalEvent = (event) => {
      setDonationRecipient(event.detail.recipient);
      setShowDonationModal(true);
    };
    
    window.addEventListener('showDonationModal', handleDonationModalEvent);
    
    // Clean up event listener
    return () => {
      window.removeEventListener('showDonationModal', handleDonationModalEvent);
    };
  }, []); // Empty dependency array means this runs once on mount

  // Fetch forum data based on current view
  useEffect(() => {
    setIsLoading(true);
    setError(null);
    
    // Fetch appropriate data based on current view
    switch(view) {
      case 'categories':
        fetchCategories();
        break;
      case 'topics':
        if (activeCategory) {
          fetchTopics(activeCategory);
        } else {
          setError('No category selected');
          setIsLoading(false);
        }
        break;
      case 'threads':
        // This view is for displaying threads within a category
        if (activeCategory) {
          fetchThreads(activeCategory); // Always refetch when sortOrder or pageNumber changes
        } else {
          setError('No category selected');
          setIsLoading(false);
        }
        break;
      case 'thread':
        if (activeThread) {
          fetchThreadPosts(activeThread);
        } else {
          setError('No thread selected');
          setIsLoading(false);
        }
        break;
      case 'create':
        // No data fetching needed for thread creation
        setIsLoading(false);
        break;
      default:
        // For any other view, just set loading to false
        console.log('Unrecognized view:', view);
        setIsLoading(false);
    }
  }, [view, activeCategory, activeThread, pageNumber, sortOrder]);
  
  // Fetch forum categories from the database via API
  const fetchCategories = () => {
    setIsLoading(true);
    latestRequestId.current += 1;
    const thisRequest = latestRequestId.current;
    console.log('[FORUM DEBUG] fetchCategories called');
    api.get('/api/forum/categories', {
      headers: { 'Cache-Control': 'no-cache' }
    })
      .then(response => {
        if (thisRequest !== latestRequestId.current) return;
        console.log('[FORUM DEBUG] Raw API response:', response.data);
        // Log the actual data property
        if (Array.isArray(response.data.data) && response.data.data.length > 0) {
          const formattedCategories = response.data.data.map(category => ({
            id: category._id,
            name: category.name,
            description: category.description,
            threadCount: category.threadCount || 0,
            postCount: category.postCount || 0,
            order: category.order || 0,
            lastUpdate: category.createdAt,
            lastPost: category.lastThread ? {
              title: 'Latest thread',
              author: 'Member',
              date: category.updatedAt || category.createdAt
            } : null
          }));
          console.log('[FORUM DEBUG] Formatted categories:', formattedCategories);
          setCategories(formattedCategories);
          setTimeout(() => { if (thisRequest === latestRequestId.current) setIsLoading(false); }, 200);
        } else {
          // No categories found, show error (no mock data per RULES.md)
          console.log('[FORUM DEBUG] No categories found, error triggered.');
          setError('No forum categories found. Please contact an administrator.');
          setTimeout(() => { if (thisRequest === latestRequestId.current) setIsLoading(false); }, 200);
        }
      })
      .catch(error => {
        if (thisRequest !== latestRequestId.current) return;
        console.error('[FORUM DEBUG] Error fetching forum categories from API:', error);
        setError('Error loading forum categories. Please try again later.');
        setTimeout(() => { if (thisRequest === latestRequestId.current) setIsLoading(false); }, 200);
      });
  };
  
  // Fetch threads within a category directly from database
  const fetchTopics = (categoryId) => {
    setIsLoading(true);
    latestRequestId.current += 1;
    const thisRequest = latestRequestId.current;
    api.get(`/api/forum/categories/${categoryId}/threads`, {
      headers: { 'Cache-Control': 'no-cache' }
    })
      .then(response => {
        if (thisRequest !== latestRequestId.current) return;
        if (response.data && response.data.threads) {
          const formattedThreads = response.data.threads.map(thread => ({
            id: thread.id || thread._id,
            slug: thread.slug,
            title: thread.title,
            author: thread.author || {
              username: 'Unknown',
              avatar: null,
              forum_rank: 'member'
            },
            createdAt: thread.createdAt,
            updatedAt: thread.updatedAt,
            replyCount: thread.replyCount || 0,
            views: thread.views || 0,
            pinned: thread.pinned || false,
            locked: thread.locked || false
          }));
          setThreads(formattedThreads);
          setTotalPages(response.data.totalPages || 1);
        }
        setTimeout(() => { if (thisRequest === latestRequestId.current) setIsLoading(false); }, 200);
      })
      .catch(error => {
        if (thisRequest !== latestRequestId.current) return;
        setError('Error loading threads. Please try again later.');
        setTimeout(() => { if (thisRequest === latestRequestId.current) setIsLoading(false); }, 200);
      });
  };
  
  // Fetch threads within a category (renamed function) - using real API
  const fetchThreads = (categoryId) => {
    setIsLoading(true);
    latestRequestId.current += 1;
    const thisRequest = latestRequestId.current;
    console.log('[FORUM DEBUG] fetchThreads called for categoryId:', categoryId);
    api.get(`/api/forum/categories/${categoryId}/threads`, {
      params: {
        page: pageNumber,
        limit: 10,
        sort: sortOrder,
        _cb: Date.now() // cache-busting param
      },
      headers: { 'Cache-Control': 'no-cache' }
    })
      .then(response => {
        if (thisRequest !== latestRequestId.current) return;
        console.log('[FORUM DEBUG] Threads returned for categoryId', categoryId, ':', response.data.threads);
        if (response.data && response.data.threads && response.data.threads.length > 0) {
          const formattedThreads = response.data.threads.map(thread => ({
            id: thread.id || thread._id,
            slug: thread.slug,
            title: thread.title,
            author: thread.author || {
              username: 'Unknown',
              avatar: null,
              forum_rank: 'member'
            },
            createdAt: thread.createdAt,
            updatedAt: thread.updatedAt,
            replyCount: thread.replyCount || 0,
            views: thread.views || 0,
            pinned: thread.pinned || false,
            locked: thread.locked || false,
            thanksCount: thread.thanksCount ?? 0,
          }));
          // Debug: Log formatted thread titles and dates
          console.log('[FORUM DEBUG] Formatted threads:', formattedThreads.map(t => ({ title: t.title, createdAt: t.createdAt })));
          setThreads(formattedThreads);
          setTotalPages(response.data.totalPages || 1);
        }
        setTimeout(() => { if (thisRequest === latestRequestId.current) setIsLoading(false); }, 200);
      })
      .catch(error => {
        if (thisRequest !== latestRequestId.current) return;
        setTimeout(() => { if (thisRequest === latestRequestId.current) setIsLoading(false); }, 200);
      });
  };
  
  // Alias for compatibility with existing code
  const fetchTopicThreads = fetchThreads;
  
  // Patch: Helper to get thread key and navigation target
  const getThreadKey = (thread) => thread.slug || thread.id;
  const getThreadNavTarget = (thread) => thread.slug ? { type: 'slug', value: thread.slug } : { type: 'id', value: thread.id };

  // Patch: Update handleThreadSelect to accept thread object
  const handleThreadSelect = (thread) => {
    setActiveThread(thread.id);
    setView('thread');
    // Try fetching by slug if present, else by id
    if (thread.slug) {
      fetchThreadPosts({ slug: thread.slug });
    } else {
      fetchThreadPosts({ id: thread.id });
    }
  };
  
  // Patch: Update fetchThreadPosts to accept either slug or id
  const fetchThreadPosts = (threadRef) => {
    setIsLoading(true);
    latestRequestId.current += 1;
    const thisRequest = latestRequestId.current;
    let url = '';
    if (threadRef.slug) {
      url = `/api/forum/thread/${threadRef.slug}`;
    } else if (threadRef.id) {
      url = `/api/forum/threads/${threadRef.id}`;
    } else if (typeof threadRef === 'string') {
      url = `/api/forum/threads/${threadRef}`;
    } else {
      setError('Invalid thread reference');
      setTimeout(() => { if (thisRequest === latestRequestId.current) setIsLoading(false); }, 200);
      return;
    }
    api.get(url, {
      params: {
        page: pageNumber,
        limit: 20
      },
      headers: { 'Cache-Control': 'no-cache' }
    })
      .then(response => {
        if (thisRequest !== latestRequestId.current) return;
        console.log('Thread posts response:', response.data);
        if (response.data) {
          if (response.data.thread) {
            const t = response.data.thread;
            const formattedThread = {
              id: t.id || t._id,
              slug: t.slug,
              title: t.title,
              author: t.author || { username: 'Unknown', avatar: null, forum_rank: 'member' },
              category: t.category,
              createdAt: t.createdAt,
              updatedAt: t.updatedAt,
              replyCount: t.replyCount || 0,
              views: t.views || 0,
              pinned: t.pinned || false,
              locked: t.locked || false
            };
            setThreads([formattedThread]);
          }
          if (response.data.posts && Array.isArray(response.data.posts)) {
            const formattedPosts = response.data.posts.map(post => ({
              id: post.id || post._id,
              content: post.content,
              author: post.author || { username: 'Unknown', avatar: null, forum_rank: 'member', createdAt: post.createdAt },
              createdAt: post.createdAt,
              edited: post.edited || null,
              isOriginalPost: post.isOriginalPost,
              thanks: post.thanks || []
            }));
            setPosts(formattedPosts);
            setTotalPages(response.data.totalPages || 1);
          }
          setTimeout(() => { if (thisRequest === latestRequestId.current) setIsLoading(false); }, 200);
        } else {
          setTimeout(() => { if (thisRequest === latestRequestId.current) setIsLoading(false); }, 200);
        }
      })
      .catch(error => {
        if (thisRequest !== latestRequestId.current) return;
        console.error('Error fetching thread posts:', error);
        setError('Error loading thread posts. Please try again later.');
        setTimeout(() => { if (thisRequest === latestRequestId.current) setIsLoading(false); }, 200);
      });
  };
  
  // Navigate to category view - modified to go directly to threads
  const handleCategorySelect = (categoryId) => {
    setActiveCategory(categoryId);
    console.log(`Selected category ID: ${categoryId}`);
    
    // Update category information in the breadcrumb
    const selectedCategory = categories.find(c => c.id === categoryId);
    console.log('Selected category:', selectedCategory ? selectedCategory.name : 'Unknown');
    
    // First set the view to threads IMMEDIATELY - this is critical
    setView('threads');
    
    // Start loading state before fetching threads
    setIsLoading(true);
    
    // Now fetch threads data - view is already set, no need to set it again
    fetchThreads(categoryId);
    
    // Skip router navigation for now
    // navigate(`/community/category/${categoryId}`);
  };
  
  // Navigate to topic threads view
  const handleTopicSelect = (topicId) => {
    setActiveTopic(topicId);
    setView('threads');
    fetchTopicThreads(topicId);
    // navigate(`/forum/topic/${topicId}`);
  };
  
  // Navigate back based on current view
  const handleBack = () => {
    switch(view) {
      case 'topics':
        setView('categories');
        setActiveCategory(null);
        break;
      case 'threads':
        // Modified to go back to categories instead of topics since we skip topics
        setView('categories');
        setActiveTopic(null);
        break;
      case 'thread':
        setView('threads');
        setActiveThread(null);
        break;
      case 'create':
        // Go back to appropriate view
        setView('threads');
        break;
      default:
        setView('categories');
    }
  };
  
  // Handle sort order change
  const handleSortChange = (newSortOrder) => {
    setSortOrder(newSortOrder);
    setPageNumber(1); // Reset to first page when changing sort order
  };
  
  // Handle pagination
  const handlePageChange = (newPage) => {
    setPageNumber(newPage);
  };
  
  // Handle thread creation
  const handleCreateThread = () => {
    setView('create');
  };
  
  // Submit new thread to the database
  const handleSubmitThread = (threadData) => {
    setIsLoading(true);
    console.log('Creating new thread:', threadData);
    
    // Prepare data for API
    const payload = {
      title: threadData.title,
      content: threadData.content,
      categoryId: activeCategory, // This is the actual category ID from selection
      pinned: threadData.isPinned || false,
      locked: threadData.isLocked || false
    };
    
    console.log('Thread payload:', payload);
    
    // Create thread in database using API
    // NOTE: Backend expects singular '/thread' for creation, even though the collection is 'threads'
    api.post('/api/forum/thread', payload)
      .then(response => {
        console.log('Thread created response:', response.data);
        if (response.data && response.data.data && response.data.data.thread) {
          // Navigate to the newly created thread
          setActiveThread(response.data.data.thread.id || response.data.data.thread._id);
          setView('thread');
          fetchThreadPosts(response.data.data.thread.id || response.data.data.thread._id);
          toast.success('Thread created successfully!');
        } else {
          console.error('Unexpected response format:', response.data);
          toast.error('Error creating thread: Unexpected server response');
        }
      })
      .catch(error => {
        console.error('Error creating thread:', error);
        
        // If we get an authorization error, we need to log in
        if (error.response?.status === 401) {
          toast.error('You need to be logged in to create a thread. Please log in and try again.');
        } else {
          toast.error('Error creating thread: ' + (error.response?.data?.message || 'Please try again later'));
        }
        
        setIsLoading(false);
      })
      .finally(() => {
        setIsLoading(false);
      });
  };
  
  // Submit new reply to a thread
  const handleSubmitReply = (replyData) => {
    api.post(`/api/forum/threads/${activeThread}/posts`, { content: replyData.content })
      .then(response => {
        if (response.data && response.data.post) {
          setTimeout(() => {
            setPosts(prev => [...prev, { ...response.data.post, author: loggedInUser }]);
          }, 700);
          toast.success('Reply posted successfully!');
        }
      })
      .catch(error => {
        toast.error('Error posting reply: ' + (error.response?.data?.message || 'Please try again later'));
      });
  };
  
  // Get reply content from textarea and post to database
  const handlePostReply = () => {
    const textarea = document.querySelector('.forum-reply-textarea');
    if (textarea && textarea.value.trim()) {
      api.post(`/api/forum/threads/${activeThread}/posts`, { content: textarea.value.trim() })
        .then(response => {
          if (response.data && response.data.post) {
            setTimeout(() => {
              setPosts(prev => [...prev, { ...response.data.post, author: loggedInUser }]);
            }, 700);
            textarea.value = '';
            toast.success('Reply posted successfully!');
          }
        })
        .catch(error => {
          toast.error('Error posting reply: ' + (error.response?.data?.message || 'Please try again later'));
        });
    } else {
      toast.error('Please enter a reply before posting');
    }
  };

  // Fetch topics for the active category when entering 'create' view
  useEffect(() => {
    if (view === 'create' && activeCategory) {
      api.get(`/api/forum/category/${activeCategory}`)
        .then(res => {
          if (res.data && res.data.data && Array.isArray(res.data.data.topics)) {
            setCategoryTopics(res.data.data.topics.map(t => ({
              id: t._id,
              name: t.name
            })));
          } else {
            setCategoryTopics([]);
          }
        })
        .catch(() => setCategoryTopics([]));
    }
  }, [view, activeCategory]);

  // In thread view, handle thread/post deletion
  const handleThreadDeleted = () => {
    toast.success('Thread deleted');
    setView('threads');
    setActiveThread(null);
    setPosts([]);
    setThreads([]); // Clear threads immediately
    if (activeCategory) {
      fetchThreads(activeCategory);
    }
  };
  const handlePostDeleted = (postId) => {
    setPosts(prev => prev.filter(p => p.id !== postId));
    toast.success('Post deleted');
  };

  // Add handler to update post in state
  const handlePostEdited = (updatedPost) => {
    setPosts(prevPosts => prevPosts.map(p => p.id === updatedPost.id ? { ...p, ...updatedPost } : p));
  };

  // Loading state
  if (isLoading) {
    return (
      <div className="w-full p-8 flex flex-col items-center justify-center">
        <div className="animate-pulse space-y-4 w-full max-w-4xl">
          <div className="h-8 bg-gray-700 rounded-md w-1/3"></div>
          <div className="h-32 bg-gray-700 rounded-md w-full"></div>
          <div className="h-32 bg-gray-700 rounded-md w-full"></div>
          <div className="h-32 bg-gray-700 rounded-md w-full"></div>
        </div>
      </div>
    );
  }

  // Error state
  if (error) {
    return (
      <div className="w-full p-8 flex flex-col items-center justify-center">
        <div className="bg-red-900 bg-opacity-50 rounded-md p-4 text-white max-w-4xl w-full">
          <h3 className="text-xl font-bold mb-2">Error</h3>
          <p>{error}</p>
          <button 
            onClick={handleBack}
            className="mt-4 bg-red-700 hover:bg-red-600 text-white px-4 py-2 rounded-md"
          >
            Go Back
          </button>
        </div>
      </div>
    );
  }

  // Render appropriate view
  return (
    <div className="relative w-full">
      <ToastContainer position="bottom-right" autoClose={5000} />
      
      {/* Header section with breadcrumb navigation and actions */}
      <div className="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
        {/* Navigation breadcrumbs */}
        <div className="flex items-center">
          {view !== 'categories' && (
            <button 
              onClick={handleBack}
              className="text-sm flex items-center mr-2 text-gray-300 hover:text-white transition-colors"
            >
              <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
              </svg>
              Back
            </button>
          )}
          
          {view === 'categories' ? (
            <h2 className="font-minecraft text-2xl bg-gradient-to-r from-purple-400 to-blue-500 bg-clip-text text-transparent">Forum Categories</h2>
          ) : view === 'topics' ? (
            <div className="flex items-center">
              <span className="text-gray-500 mx-2">/</span>
              <h2 className="font-bold text-xl text-white">{activeCategory?.name || 'Topics'}</h2>
            </div>
          ) : view === 'threads' ? (
            <div className="flex items-center">
              <span className="text-gray-500 mx-2">/</span>
              <h2 className="font-bold text-xl text-white">{activeCategory?.name || 'Threads'}</h2>
            </div>
          ) : view === 'thread' ? (
            <div className="flex items-center">
              <span className="text-gray-500 mx-2">/</span>
              <h2 className="font-bold text-xl text-white truncate max-w-xs sm:max-w-md">
                {threads.find(t => getThreadKey(t) === activeThread)?.title || 'Thread'}
              </h2>
            </div>
          ) : view === 'create' ? (
            <div className="flex items-center">
              <span className="text-gray-500 mx-2">/</span>
              <h2 className="font-bold text-xl text-white">Create New Thread</h2>
            </div>
          ) : null}
        </div>
        
        {/* Action buttons */}
        <div className="flex items-center space-x-2">
          {view === 'categories' || view === 'topics' || view === 'threads' ? (
            <button 
              onClick={() => {
                setIsLoading(true);
                setError(null);
                fetchCategories();
              }}
              className="text-sm bg-gray-700 hover:bg-gray-600 text-white py-1 px-3 rounded-md flex items-center transition-colors"
            >
              <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              Refresh
            </button>
          ) : null}
          
          {/* Post action buttons for thread view */}
          {view === 'threads' && loggedInUser && (
            <button 
              onClick={handleCreateThread}
              className="text-sm bg-purple-700 hover:bg-purple-600 text-white py-1 px-3 rounded-md flex items-center transition-colors"
            >
              <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
              </svg>
              New Thread
            </button>
          )}
          
          {view === 'thread' && loggedInUser && (
            <button 
              onClick={handlePostReply}
              className="text-sm bg-purple-700 hover:bg-purple-600 text-white py-1 px-3 rounded-md flex items-center transition-colors"
            >
              <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
              </svg>
              Reply
            </button>
          )}
        </div>
      </div>
      
      {/* Loading state */}
      {isLoading ? (
        <div className="flex justify-center py-10">
          <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-green-500"></div>
        </div>
      ) : error ? (
        <div className="bg-red-900 bg-opacity-20 border border-red-900 text-red-300 px-4 py-3 rounded-lg">
          <p>{error}</p>
        </div>
      ) : (
        <>
          {/* Display appropriate content based on current view */}
          <AnimatePresence mode="wait">
            {view === 'categories' && (
              <motion.div
                key="categories"
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -20 }}
                transition={{ duration: 0.3 }}
              >
                <div className="mb-6 p-5 bg-gray-800/50 backdrop-blur-sm rounded-lg border border-gray-700 shadow-lg">
                  <h3 className="text-lg font-minecraft text-white mb-3">Welcome to the BizzyLink Forum</h3>
                  <p className="text-gray-300 text-sm">
                    Connect with our community, share your Minecraft experiences, get help, and discover the latest news and updates.
                  </p>
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                  {categories.map(category => (
                    <ForumCategory
                      key={category.id}
                      category={category}
                      onClick={() => handleCategorySelect(category.id)}
                    />
                  ))}
                </div>
              </motion.div>
            )}
            
            {/* Other view content - keep all other views the same */}
            {view === 'topics' && (
              <motion.div
                key="topics"
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -20 }}
                transition={{ duration: 0.3 }}
              >
                <ForumTopicList
                  topics={topics}
                  onTopicSelect={handleTopicSelect}
                />
              </motion.div>
            )}
            
            {view === 'threads' && (
              <motion.div
                key="threads"
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -20 }}
                transition={{ duration: 0.3 }}
              >
                <div className="flex flex-col-reverse sm:flex-row justify-between items-start sm:items-center mb-4">
                  <div className="flex justify-center sm:justify-start mt-3 sm:mt-0">
                    <button 
                      onClick={() => handleSortChange('newest')}
                      className={`px-3 py-1 text-xs rounded-md mr-2 ${sortOrder === 'newest' ? 'bg-purple-700 text-white' : 'bg-gray-700 text-gray-300'}`}
                    >
                      Newest
                    </button>
                    <button 
                      onClick={() => handleSortChange('oldest')}
                      className={`px-3 py-1 text-xs rounded-md mr-2 ${sortOrder === 'oldest' ? 'bg-purple-700 text-white' : 'bg-gray-700 text-gray-300'}`}
                    >
                      Oldest
                    </button>
                    <button 
                      onClick={() => handleSortChange('popular')}
                      className={`px-3 py-1 text-xs rounded-md ${sortOrder === 'popular' ? 'bg-purple-700 text-white' : 'bg-gray-700 text-gray-300'}`}
                    >
                      Popular
                    </button>
                  </div>
                </div>
                
                {/* Thread listing */}
                <div className="border border-gray-700 rounded-lg overflow-hidden">
                  {threads.length === 0 ? (
                    <div className="p-8 text-center">
                      <div className="text-gray-400 text-4xl mb-3">📭</div>
                      <h3 className="text-lg font-bold text-white mb-2">No Threads Yet</h3>
                      <p className="text-gray-400 mb-6">Be the first to start a discussion in this category!</p>
                      {loggedInUser && (
                        <button 
                          onClick={handleCreateThread}
                          className="mx-auto bg-purple-700 hover:bg-purple-600 text-white py-2 px-4 rounded-md flex items-center justify-center transition-colors"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                          </svg>
                          Create Thread
                        </button>
                      )}
                    </div>
                  ) : (
                    <div className="divide-y divide-gray-700">
                      {threads.map(thread => (
                        <ForumThread
                          key={getThreadKey(thread)}
                          thread={thread}
                          onClick={() => handleThreadSelect(thread)}
                        />
                      ))}
                    </div>
                  )}
                </div>
                
                {/* Pagination */}
                {totalPages > 1 && (
                  <div className="flex justify-center mt-6">
                    <div className="flex space-x-1">
                      {pageNumber > 1 && (
                        <button 
                          onClick={() => handlePageChange(pageNumber - 1)}
                          className="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded-md"
                        >
                          Prev
                        </button>
                      )}
                      
                      {Array.from({ length: totalPages }).map((_, i) => (
                        <button
                          key={i}
                          onClick={() => handlePageChange(i + 1)}
                          className={`

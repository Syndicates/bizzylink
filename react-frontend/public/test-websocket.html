<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Connection Test</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
    <h1>WebSocket Connection Test</h1>
    <p>This page tests the Socket.IO connection to the backend</p>
    
    <div id="status">Connecting...</div>
    <button id="connect">Force Connect</button>
    <button id="disconnect">Disconnect</button>
    
    <script>
        (function() {
            const statusEl = document.getElementById('status');
            const connectBtn = document.getElementById('connect');
            const disconnectBtn = document.getElementById('disconnect');
            
            // Create socket connection
            const socket = io('http://localhost:8080', {
                autoConnect: true,
                reconnection: true,
                reconnectionAttempts: Infinity,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                timeout: 20000,
                forceNew: true
            });
            
            // Add to window for inspection
            window.testSocket = socket;
            
            // Event listeners
            socket.on('connect', () => {
                statusEl.textContent = 'Connected!';
                statusEl.style.color = 'green';
                console.log('Socket connected with ID:', socket.id);
                
                // Try to authenticate
                try {
                    // Get token from localStorage if available
                    const token = localStorage.getItem('bizzylink_auth_token');
                    if (token) {
                        socket.emit('authenticate', token);
                        console.log('Sent authentication token');
                    } else {
                        console.log('No authentication token found');
                    }
                } catch (err) {
                    console.error('Authentication error:', err);
                }
            });
            
            socket.on('disconnect', (reason) => {
                statusEl.textContent = 'Disconnected: ' + reason;
                statusEl.style.color = 'red';
                console.log('Socket disconnected:', reason);
            });
            
            socket.on('error', (error) => {
                statusEl.textContent = 'Error: ' + error;
                statusEl.style.color = 'red';
                console.error('Socket error:', error);
            });
            
            socket.on('reconnect_attempt', (attempt) => {
                statusEl.textContent = 'Reconnecting... Attempt ' + attempt;
                statusEl.style.color = 'orange';
                console.log('Reconnection attempt:', attempt);
            });
            
            // Button handlers
            connectBtn.addEventListener('click', () => {
                console.log('Manual connect triggered');
                
                // Override the autoConnect setting first
                if (socket.io && socket.io.opts) {
                    socket.io.opts.autoConnect = true;
                    console.log('Forced autoConnect to true');
                }
                
                if (socket.io && socket.io._reconnection === false) {
                    socket.io.reconnection(true);
                    console.log('Enabled reconnection');
                }
                
                // Try to connect
                socket.connect();
            });
            
            disconnectBtn.addEventListener('click', () => {
                console.log('Manual disconnect triggered');
                socket.disconnect();
            });
            
            // Check for the Auto refresh disabled error
            const originalConsoleError = console.error;
            console.error = function(...args) {
                if (args[0] && typeof args[0] === 'string' && args[0].includes('Auto refresh is disabled')) {
                    console.log('INTERCEPTED "Auto refresh is disabled" error');
                    
                    // Try to force socket reconnection
                    if (socket && socket.io) {
                        console.log('Attempting emergency fix for auto refresh disabled');
                        
                        // Force enable auto refresh at the IO manager level
                        if (socket.io.engine && socket.io.engine.transport) {
                            console.log('Patching engine transport');
                            socket.io.engine.transport.writable = true;
                        }
                        
                        // Enable auto connect
                        socket.io.opts.autoConnect = true;
                        
                        // Try reconnect
                        setTimeout(() => {
                            try {
                                socket.connect();
                            } catch (e) {
                                console.log('Emergency reconnect attempt failed:', e);
                            }
                        }, 500);
                    }
                }
                
                // Call original console.error
                originalConsoleError.apply(console, args);
            };
        })();
    </script>
</body>
</html>
